# FOTA

## FW layout in storage
```text
    +--------------------------------------------------------------------------------+
    |   Update candidate layout on storage                                           |
    |                                                                                |
    |    +---------------------------+  <- MBED_CLOUD_CLIENT_FOTA_STORAGE_START_ADDR |
    |    |   Candidate Ready Header  |   * Alignment to BD program size *            |
    |    +---------------------------+  <- FW header Structure start                 |
    |    |                           |                                               |
    |    |      Firmware Header      |   * Alignment to BD program size *            |
    |    |                           |                                               |
    |    +---------------------------+  <- FW header Structure end                   |
    |    |                           |   * Alignment to BD program size *            |
    |    |                           |                                               |
    |    |                           |                                               |
    |    |        Firmware           |                                               |
    |    |                           |                                               |
    |    |                           |                                               |
    |    |                           |                                               |
    |    +---------------------------+  <- fota_ctx.storage_end_addr                 |
    |                                    * Alignment to BD erase size *              |
    +---------------------------------------------------------------------------------------------------------+
    |                                                                                                         |
    |   +---------------------------+         +-------------------------+-----------------------------------+ |
    |   |   Candidate Ready Header  +---------|  Magic - 0xfed54e01     | Component name (8 bytes)          | |
    |   |                           |         |     (4 Bytes)           |                                   | |
    |   +---------------------------+         +-------------------------------------------------------------+ |
    |   |                           |                                                                         |
    |   |      Firmware Header      +---------+-------------------------------------------------------------+ |
    |   |                           |         |  Magic - 0x5c0253a3     |   FW size (4 Bytes)               | |
    |   |                           |         |     (4 Bytes)           |                                   | |
    |   +---------------------------+         +-------------------------+-----------------------------------+ |
    |   |                           |         |         FW Version (8 Bytes)                                | |
    |   |                           |         +-------------------------------------------------------------+ |
    |   |                           |         |                                                             | |
    |   |        Firmware           |         |           FW Signature (ECDSA) (64 Bytes)                   | |
    |   |                           |         |           (only if signature is supported)                  | |
    |   |                           |         |                                                             | |
    |   |                           |         +-------------------------------------------------------------+ |
    |   +------------+--------------+         |                                                             | |
    |                |                        |           FW Digest (SHA-256) (32 Bytes)                    | |
    |                |                        |                                                             | |
    |                |                        +----------------------+-------------------+------------------+ |
    |                |                        + Int. header barrier  | Flags (1 Byte)    | Candidate block  | |
    |                |                        |       (1 Byte)       |                   | size             | |
    |                |                        |                      |                   | (2 Bytes)        | |
    |                |                        +----------------------+-------------------+------------------+ |
    |                |                        |                                                             | |
    |                |                        |          Precursor Digest (SHA-256) (32 Bytes)              | |
    |                |                        |                                                             | |
    |                |                        +-------------------------------------------------------------+ |
    |                |                                                                                        |
    |                |                                                                                        |
    |                +---------------------------------------------------+                                    |
    |                |                                                   |                                    |
    |                V                                                   V                                    |
    |                                                                                                         |
    |        Encrypted firmware layout                        Non Encrypted firmware layout                   |
    |   +--------------------------------------+           +--------------------------------------+           |
    |   |     Encryption Block 1               |           |                                      |           |
    |   +--------------------------------------+           |                                      |           |
    |   |     Encryption Block 2               |           |                                      |           |
    |   +--------------------------------------+           |                                      |           |
    |   |               .                      |           |            Firmware Data             |           |
    |   |               .                      |           |                                      |           |
    |   |               .                      |           |                                      |           |
    |   +--------------------------------------+           |                                      |           |
    |   |     Encryption Block N               +---+       |                                      |           |
    |   +--------------------------------------+   |       +--------------------------------------+           |
    |                                              |                                                          |
    |                                              |                                                          |
    |                                              V                                                          |
    |   +-----------------------+------------------------------------------------------------+                |
    |   | AES-CCM Tag (8 bytes) | Encrypted Firmware Data (Encryption Block Size - 8 Bytes)  |                |
    |   +------------------------------------------------------------------------------------+                |
    +---------------------------------------------------------------------------------------------------------+
```
